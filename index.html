<!DOCTYPE html>
<html>
<head>
    <title>EVE Online SSO SPA</title>
</head>
<body>
    <button id="login">Log in with EVE Online</button>
    <div id="killsContainer"></div>
    <script>
        // Fetch market prices for calculating kill values
        let marketPrices = [];
        async function fetchMarketPrices() {
            const response = await fetch('https://esi.evetech.net/latest/markets/prices/?datasource=tranquility');
            marketPrices = await response.json();
        }

        // Calculate the total value of a killmail
        async function calculateKillValue(killmail) {
            let totalValue = 0;
            const shipPrice = marketPrices.find(p => p.type_id === killmail.victim.ship_type_id)?.average_price || 0;
            totalValue += shipPrice;

            for (const item of killmail.victim.items) {
                const itemPrice = marketPrices.find(p => p.type_id === item.item_type_id)?.average_price || 0;
                totalValue += itemPrice * (item.quantity_dropped || 0);
                totalValue += itemPrice * (item.quantity_destroyed || 0);
            }

            return totalValue;
        }

        function formatValue(value) {
            if (value >= 1000000000) {
                return (value / 1000000000).toFixed(1) + 'B';
            } else if (value >= 100000000) {
                return Math.round(value / 1000000) + 'M';
            } else {
                return (value / 1000000).toFixed(1) + 'M';
            }
        }

        // Handle login button click
        document.getElementById('login').addEventListener('click', function() {
            window.location.href = 'https://login.eveonline.com/v2/oauth/authorize?response_type=code&redirect_uri=https://o7eve.github.io/&client_id=your_client_id&scope=esi-killmails.read_killmails.v1';
        });

        // Check if the page was loaded with an authorization code
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        if (code) {
            // Send the authorization code to the Netlify Function
            fetch('/.netlify/functions/eve-sso', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code }),
            })
            .then(response => response.json())
            .then(async data => {
                const accessToken = data.accessToken;
                const characterId = data.characterId;
                console.log('Access Token:', accessToken);
                console.log('Character ID:', characterId);
                
                // Fetch the last 10 kills for the character
                const killsResponse = await fetch(`https://esi.evetech.net/latest/characters/${characterId}/killmails/recent/?datasource=tranquility`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });
                const kills = await killsResponse.json();

                // Calculate kill values and display them
                const killsContainer = document.getElementById('killsContainer');
                for (const kill of kills.slice(0, 10)) {
                    const killValue = await calculateKillValue(kill);
                    const killElement = document.createElement('div');
                    killElement.innerHTML = `
                        <img src="https://images.evetech.net/types/${kill.victim.ship_type_id}/icon" alt="Ship Icon">
                        <span>${formatValue(killValue)}</span>
                    `;
                    killsContainer.appendChild(killElement);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        fetchMarketPrices();
    </script>
</body>
</html>

