<!DOCTYPE html>
<html>
<head>
    <title>EVE Online SPA</title>
    <style>
        body {
            background-color: black;
            color: green;
            font-weight: bold;
        }
        .kill {
            display: inline-block;
            text-align: center;
            margin-right: 10px;
        }
        .kill img {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>EVE Online SPA</h1>
    <p>Welcome to your EVE Online single-page application!</p>
    <button id="login-button">Log in with EVE Online</button>

    <div id="killmails-container"></div>
    <div id="countdown-timer">Refreshing in 60 seconds...</div>
    <div id="character-info"></div>

    <script>
        let accessToken = '';
        let characterId = '';

        document.getElementById('login-button').addEventListener('click', function() {
            var state = generateState();
            // Redirect the user to the EVE SSO login page
            window.location.href = 'https://login.eveonline.com/v2/oauth/authorize/?response_type=code&redirect_uri=https%3A%2F%2Ffriendly-puppy-d4bfa8.netlify.app%2Fcallback&client_id=8becdadbea7d46adabbcf20af467fac8&scope=esi-killmails.read_killmails.v1&state=' + state;
        });

        // Extract the code from URL parameters if present
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        if (code) {
            // Token endpoint details omitted for brevity
            // Assume accessToken and characterId are set here
            fetchAndDisplayKillmails(); // Initial fetch
            setInterval(fetchAndDisplayKillmails, 60000); // Set up refresh every 60 seconds
        }

        function fetchAndDisplayKillmails() {
            console.log('Fetching killmails...');
            fetch(`https://esi.evetech.net/v1/characters/${characterId}/killmails/recent/?datasource=tranquility`, {
                headers: { Authorization: `Bearer ${accessToken}` },
            })
            .then(response => response.json())
            .then(data => {
                console.log('Killmails data:', data); // Log the raw data for debugging
                if (!data || data.error) {
                    console.error('Error fetching killmails:', data);
                    return;
                }
                const killmailsContainer = document.getElementById('killmails-container');
                killmailsContainer.innerHTML = ''; // Clear existing content

                data.slice(0, 10).forEach(killmail => { // Process top 10 killmails
                    fetch(`https://esi.evetech.net/v1/killmails/${killmail.killmail_id}/${killmail.killmail_hash}/?datasource=tranquility`)
                    .then(response => response.json())
                    .then(details => {
                        console.log(`Details for killmail ID ${killmail.killmail_id}:`, details); // Log details for debugging
                        // Assume calculateKillValue() and formatValue() are correctly implemented
                        const shipTypeId = details.victim.ship_type_id;
                        const killValue = calculateKillValue(details); // Mock calculation
                        const shipIconUrl = `https://images.evetech.net/types/${shipTypeId}/icon`;

                        const killmailElement = document.createElement('div');
                        killmailElement.className = 'kill';
                        killmailElement.innerHTML = `<img src="${shipIconUrl}" alt="Ship Icon"><span>${killValue}</span>`;
                        killmailsContainer.appendChild(killmailElement);
                    })
                    .catch(error => console.error('Error fetching killmail details:', error));
                });
            })
            .catch(error => console.error('Error fetching recent killmails:', error));
        }

        function calculateKillValue(killmail) {
            // Dummy implementation for demonstration
            return '100M ISK'; // Placeholder value
        }

        function generateState() {
            let state = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < 16; i++) {
                state += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return state;
        }
    </script>
</body>
</html>

</html>

