<!DOCTYPE html>
<html>
<head>
    <title>EVE Online Dsss5ssDD SPA</title>
    <style>
        body {
            background-color: black;
            color: green;
            font-weight: bold;
        }
        .kill {
            display: inline-block;
            text-align: center;
            margin-right: 10px;
        }
        .kill img {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>EVE Online SPA</h1>
    <p>Welcome to your EVE Online single-page application!</p>
    <button id="login-button">Log in with EVE Online</button>

    <div id="killmails-container"></div>
    <div id="countdown-timer">Refreshing in 60 seconds...</div>
    <div id="character-info"></div>

    <script>
        let accessToken = '';
        let refreshToken = '';
        let characterId = '';

        function generateState() {
            var state = '';
            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (var i = 0; i < 16; i++) {
                state += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return state;
        }

        var state = generateState();
        document.getElementById('login-button').addEventListener('click', function() {
            // Redirect the user to the EVE SSO login page
            window.location.href = 'https://login.eveonline.com/v2/oauth/authorize/?response_type=code&redirect_uri=https%3A%2F%2Ffriendly-puppy-d4bfa8.netlify.app%2Fcallback&client_id=8becdadbea7d46adabbcf20af467fac8&scope=esi-killmails.read_killmails.v1&state=' + state;
        });

        // Check if access token and refresh token are available in the URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
            fetch('https://login.eveonline.com/v2/oauth/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Basic ' + btoa('8becdadbea7d46adabbcf20af467fac8:YL1hieqstuYMwZ3p3WWTncxBdVTgck3PUrIyPzK4')
                },
                body: 'grant_type=authorization_code&code=' + code
            })
            .then(response => response.json())
            .then(data => {
                accessToken = data.access_token;
                refreshToken = data.refresh_token;
                extractCharacterInfo(data.access_token); // Extract character info
                fetchAndDisplayKillmails();
                setInterval(fetchAndDisplayKillmails, 60000); // Refresh every 60 seconds
            })
            .catch(error => {
                console.error('Error getting access token:', error);
            });
        }

        function extractCharacterInfo(jwtToken) {
            const [header, payload, signature] = jwtToken.split('.');
            const decodedPayload = JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/')));
            const characterName = decodedPayload.name;
            characterId = decodedPayload.sub.split(':')[2]; // Assuming the format is "CHARACTER:EVE:<character_id>"

            // Update the HTML content with the character name and ID
            const characterInfoContainer = document.getElementById('character-info');
            characterInfoContainer.innerHTML = `Character Name: ${characterName}, Character ID: ${characterId}`;
        }

function fetchAndDisplayKillmails() {
    fetch(`https://esi.evetech.net/v1/characters/${characterId}/killmails/recent/`, {
        headers: {
            Authorization: 'Bearer ' + accessToken,
        },
    })
    .then(response => response.json())
    .then(data => {
        console.log('Raw data:', data);
        if (!Array.isArray(data)) {
            console.error('Error: Data is not an array.');
            return;
        }

        const filteredKillmails = data.filter(killmail => {
            if (!killmail.attackers) {
                console.error('Error: Killmail has no attackers.', killmail);
                return false;
            }
            return killmail.attackers.some(attacker => attacker.character_id === characterId);
        });

        const killmailsContainer = document.getElementById('killmails-container');
        killmailsContainer.innerHTML = '';

        filteredKillmails.forEach(killmail => {
            fetch(`https://esi.evetech.net/v1/killmails/${killmail.killmail_id}/${killmail.killmail_hash}/`)
            .then(response => response.json())
            .then(details => {
                // Process the killmail details here
                // For each killmail, calculate the kill value, get the ship icon, and display it
                // Example:
                const shipTypeId = details.victim.ship_type_id;
                const killValue = calculateKillValue(details);
                const shipIconUrl = `https://images.evetech.net/types/${shipTypeId}/icon`;

                const killmailElement = document.createElement('div');
                killmailElement.className = 'kill';
                killmailElement.innerHTML = `
                    <img src="${shipIconUrl}" alt="Ship Icon">
                    <span>${formatValue(killValue)}</span>
                `;
                killmailsContainer.appendChild(killmailElement);
            })
            .catch(error => {
                console.error('Error fetching killmail details:', error);
            });
        });
    })
    .catch(error => {
        console.error('Error fetching recent killmails:', error);
    });
}


        function calculateKillValue(killmail) {
            // Implement the kill value calculation here
            // Use the marketPrices array to get item prices
        }

        function formatValue(value) {
            // Implement the value formatting here
        }
    </script>
</body>
</html>

