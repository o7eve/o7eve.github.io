<!DOCTYPE html>
<html>
<head>
    <title>11KILLFEED SPA TEST</title>
    <style>
        body {
            background-color: black;
            color: green;
            font-weight: bold;
            margin: 0;
            padding: 0;
        }
        .kill {
            display: inline-block;
            text-align: center;
            margin-right: 10px;
        }
        .kill img {
            display: block;
            margin-bottom: 5px;
        }
        #header {
            text-align: center;
            padding-top: 20px;
        }
        #icons {
            text-align: left;
            padding-top: 100px;
            padding-left: 20px;
        }
        #login-button {
            margin-top: 20px; /* Added margin */
        }
        #character-info {
            text-align: left;
            margin-left: 20px;
            padding-top: 10px;
        }
        #description {
            text-align: left;
            padding-top: 10px;
            margin-left: 20px;
        }
    </style>
</head>
<body>
    <div id="icons"></div>
    <button id="login-button">Log in with EVE Online</button>

    <div id="character-info"></div>
    <h2 id="heading">  KILLFEED SPA</h2>
    <p>  This tool displays your 10 most recent kills.</p>
    <p>  Login via the EVE SSO.</p>
    <p>  It will refresh every 60 seconds.</p>
    <p>  Go here for more instructions:  https://o7eve.github.io/README.md </p>
    <p>  My in-game name is: William Friedman</p>
    <p>  o7 </p>
    
    <script>
        // Function to generate a random state for OAuth
        function generateState() {
            var state = '';
            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (var i = 0; i < 16; i++) {
                state += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return state;
        }

        // Function to extract character information from the JWT token
function extractCharacterInfo(jwtToken) {
    const [header, payload, signature] = jwtToken.split('.');
    const decodedPayload = JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/')));
    const characterName = decodedPayload.name;
    characterId = parseInt(decodedPayload.sub.split(':')[2], 10);

    const characterInfoContainer = document.getElementById('character-info');
    characterInfoContainer.innerHTML = `Character Name: ${characterName}, Character ID: ${characterId}`;
}

        // Function to fetch and display recent killmails
        function fetchAndDisplayKillmails() {
            fetch(`https://esi.evetech.net/v1/characters/${characterId}/killmails/recent/`, {
                headers: {
                    Authorization: 'Bearer ' + accessToken,
                },
            })
            .then(response => response.json())
            .then(killmails => {
                const killmailDetailsPromises = killmails.map(killmail =>
                    fetch(`https://esi.evetech.net/v1/killmails/${killmail.killmail_id}/${killmail.killmail_hash}/`)
                    .then(response => response.json())
                );

                Promise.all(killmailDetailsPromises)
                .then(killmailDetails => {
                    const filteredKillmails = killmailDetails.filter(details => parseInt(details.victim.character_id, 10) !== characterId);
                    const sortedKillmails = filteredKillmails.sort((a, b) => new Date(b.killmail_time) - new Date(a.killmail_time)).slice(0, 10);
                    const iconsContainer = document.getElementById('icons');
                    iconsContainer.innerHTML = '';

                    sortedKillmails.forEach(details => {
                        const shipTypeId = details.victim.ship_type_id;
                        const shipIconUrl = `https://images.evetech.net/types/${shipTypeId}/icon`;

                        const killmailElement = document.createElement('div');
                        killmailElement.className = 'kill';
                        killmailElement.innerHTML = `
                            <img src="${shipIconUrl}" alt="Ship Icon">
                            <span>${calculateKillValue(details)}</span>
                        `;
                        iconsContainer.appendChild(killmailElement);
                    });
                })
                .catch(error => {
                    console.error('Error fetching killmail details:', error);
                });
            })
            .catch(error => {
                console.error('Error fetching recent killmails:', error);
            });
        }

        // Function to calculate the value of a killmail
        function calculateKillValue(killmail) {
            let totalValue = 0;

            const shipPrice = marketPrices.find(p => p.type_id === killmail.victim.ship_type_id)?.average_price || 0;
            totalValue += shipPrice;

            for (const item of killmail.victim.items) {
                const itemPrice = marketPrices.find(p => p.type_id === item.item_type_id)?.average_price || 0;
                totalValue += itemPrice * (item.quantity_dropped || 0);
                totalValue += itemPrice * (item.quantity_destroyed || 0);
            }

            return formatValue(totalValue);
        }

        // Function to format the value
        function formatValue(value) {
            if (value >= 1000000000) {
                return (value / 1000000000).toFixed(1) + 'B';
            } else if (value >= 1000000) {
                return (value / 1000000).toFixed(1) + 'M';
            } else {
                return (value / 1000).toFixed(1) + 'K';
            }
        }

        // Function to fetch market prices
        async function fetchMarketPrices() {
            const response = await fetch('https://esi.evetech.net/latest/markets/prices/');
            marketPrices = await response.json();
        }

        // Initializing variables
        let accessToken = localStorage.getItem('ACCESS_TOKEN');
        let refreshToken = localStorage.getItem('REFRESH_TOKEN');
        let characterId = '';
        let marketPrices = [];

        // Function to fetch the client ID and secret from the Netlify Function
        function fetchCredentials() {
            return fetch('https://friendly-puppy-d4bfa8.netlify.app/.netlify/functions/getCredentials')
                .then(response => response.json());
        }

        // Main script
        var state = generateState();
        fetchCredentials()
            .then(credentials => {
                document.getElementById('login-button').addEventListener('click', function() {
                    window.location.href = 'https://login.eveonline.com/v2/oauth/authorize/?response_type=code&redirect_uri=' + encodeURIComponent('https://friendly-puppy-d4bfa8.netlify.app/callback') + '&client_id=' + credentials.clientId + '&scope=esi-killmails.read_killmails.v1&state=' + state;
                });

                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');

                if (code) {
                    fetch('https://login.eveonline.com/v2/oauth/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Authorization': 'Basic ' + btoa(credentials.clientId + ':' + credentials.clientSecret)
                        },
                        body: 'grant_type=authorization_code&code=' + code
                    })
                    .then(response => response.json())
                    .then(data => {
                        accessToken = data.access_token;
                        refreshToken = data.refresh_token;
                        localStorage.setItem('ACCESS_TOKEN', accessToken);
                        localStorage.setItem('REFRESH_TOKEN', refreshToken);
                        extractCharacterInfo(data.access_token);
                        fetchMarketPrices();
                        fetchAndDisplayKillmails();
                        setInterval(fetchAndDisplayKillmails, 60000);
                    })
                    .catch(error => {
                        console.error('Error getting access token:', error);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching credentials:', error);
            });
    </script>
</body>
</html>
